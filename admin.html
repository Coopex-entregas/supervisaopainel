<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Coopex</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--brand:#003399;--line:#e2e9ff}
*{box-sizing:border-box}html,body{margin:0}
body{font-family:Inter,system-ui,Arial;background:#fff;color:#0b1838}
.header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#fff;z-index:5}
.badge{width:36px;height:36px;border-radius:50%;background:conic-gradient(from 130deg,#2563eb,#003399)}
.wrap{max-width:1000px;margin:0 auto;padding:16px}
.card{border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;background:#fff}
.section-title{margin:0 0 8px;font-weight:800}
.row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;margin:8px 0}
label{font-weight:800}
input[type=text],input[type=url],input[type=email],input[type=password],textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
textarea{min-height:80px}
button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#f5f8ff;font-weight:800;cursor:pointer}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
.small{color:#444;font-size:.9rem}
.success{color:#0a7a2a;font-weight:700}
.error{color:#a30000;font-weight:700}
.uploader{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type=file]{background:#fff}
.link-row,.video-row{display:grid;gap:8px;align-items:center;margin:8px 0}
.link-row{grid-template-columns:1.1fr 1.6fr 1fr 1.6fr 1fr auto}
.video-row{grid-template-columns:1.2fr 1.6fr 1fr 1fr auto}
.preview{width:40px;height:40px;border-radius:8px;border:1px solid var(--line);object-fit:cover;background:#fff}
@media (max-width:900px){
  .row{grid-template-columns:1fr}
  .link-row,.video-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="header">
  <div class="badge"></div>
  <div>
    <b>Admin • COOPEX</b>
    <div class="small">Faça upload das logos, ícones dos links e vídeos. Depois clique em <b>Salvar no Firebase</b>.</div>
  </div>
  <div style="margin-left:auto" id="authArea">
    <input id="email" type="email" placeholder="admin@coopex.com.br"/>
    <input id="pass" type="password" placeholder="Senha"/>
    <button id="btnLogin">Entrar</button>
  </div>
  <div style="margin-left:auto;display:none" id="loggedArea">
    <span id="who" class="small"></span>
    <button id="btnLogout">Sair</button>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="actions">
      <button id="btnLoad">Carregar do Firebase</button>
      <button id="btnSave">Salvar no Firebase</button>
      <button id="btnDownload">Baixar config.json</button>
      <button id="btnCopy">Copiar link público</button>
      <span id="msg" class="small"></span>
    </div>
  </div>

  <div class="card">
    <h3 class="section-title">Perfil</h3>
    <div class="row"><label>Nome</label><input id="name" type="text"></div>
    <div class="row"><label>@handle / subtítulo</label><input id="handle" type="text"></div>
    <div class="row"><label>Quadro de Aviso</label><textarea id="notice"></textarea></div>
    <div class="row"><label>Mostrar aviso?</label><input id="showNotice" type="checkbox" checked></div>
    <hr/>
    <div class="row"><label>Logo topo (redonda)</label>
      <div class="uploader">
        <img id="topLogoPrev" class="preview" alt="">
        <input id="topLogoUrl" type="url" placeholder="URL do upload (preenchida após enviar)">
        <input id="topLogoFile" type="file" accept="image/*">
        <button id="topLogoBtn" type="button">Upload</button>
      </div>
    </div>
    <div class="row"><label>Logo COOPEX (rodapé)</label>
      <div class="uploader">
        <img id="brandCoopexPrev" class="preview" alt="">
        <input id="brandCoopexUrl" type="url" placeholder="URL do upload (preenchida após enviar)">
        <input id="brandCoopexFile" type="file" accept="image/*">
        <button id="brandCoopexBtn" type="button">Upload</button>
      </div>
    </div>
    <div class="row"><label>Logo Kratos (rodapé)</label>
      <div class="uploader">
        <img id="brandKratosPrev" class="preview" alt="">
        <input id="brandKratosUrl" type="url" placeholder="URL do upload (preenchida após enviar)">
        <input id="brandKratosFile" type="file" accept="image/*">
        <button id="brandKratosBtn" type="button">Upload</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 class="section-title">Links (ícone via upload)</h3>
    <div id="links"></div>
    <div class="actions"><button id="addLink">+ adicionar link</button></div>
  </div>

  <div class="card">
    <h3 class="section-title">Vídeos (upload do arquivo)</h3>
    <div class="small">Ao enviar o vídeo, o item fica com <b>type: "mp4url"</b> e o campo <b>src</b> apontando para o Firebase. O poster é opcional.</div>
    <div id="videos"></div>
    <div class="actions"><button id="addVideo">+ adicionar vídeo</button></div>
  </div>
</div>

<script type="module">
/* Firebase SDKs */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

/* ===== CONFIG FIREBASE (bucket correto) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyA0nxRSImbagy4EbWgLD9_2Hr_PYtWVPnM",
  authDomain: "kratossystemlinks.firebaseapp.com",
  projectId: "kratossystemlinks",
  storageBucket: "kratossystemlinks.appspot.com",
  messagingSenderId: "721987032189",
  appId: "1:721987032189:web:9a82953e128b9398c04d14"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app, 'gs://kratossystemlinks.appspot.com');
const DOC_ID = "supervisaopainel";

/* ===== Util ===== */
const $=s=>document.querySelector(s);
const msg=(t,ok=true)=>{ const el=$('#msg'); el.textContent=t; el.className=ok?'small success':'small error'; };
function setPreview(imgSel, url){ const el=$(imgSel); if(url){ el.src=url; el.style.visibility='visible'; } else { el.removeAttribute('src'); el.style.visibility='hidden'; } }

/* ===== Auth ===== */
onAuthStateChanged(auth,u=>{
  if(u){ $('#authArea').style.display='none'; $('#loggedArea').style.display='flex'; $('#who').textContent=u.email; }
  else { $('#authArea').style.display='flex'; $('#loggedArea').style.display='none'; }
});
$('#btnLogin').addEventListener('click', async ()=>{
  try{ await signInWithEmailAndPassword(auth,$('#email').value.trim(),$('#pass').value); msg('Login OK'); }
  catch(e){ msg('Falha no login: '+(e.message||e.code),false); }
});
$('#btnLogout').addEventListener('click', async ()=>{ await signOut(auth); msg('Saiu.'); });

/* ===== State ===== */
function empty(){ return {
  profile:{name:'',handle:'',topLogoUrl:'',brandCoopexUrl:'',brandKratosUrl:'',showNotice:true,notice:''},
  links:[],
  videos:[]
};}
let state = empty();

/* ===== Upload helper ===== */
async function uploadTo(prefix, file){
  if(!file) throw new Error('Selecione um arquivo.');
  const path = `${prefix}/${Date.now()}-${file.name}`;
  const r = sref(storage, path);
  await uploadBytes(r, file);
  return await getDownloadURL(r);
}

/* ===== Perfil bindings ===== */
function fillProfile(){
  $('#name').value=state.profile.name||'';
  $('#handle').value=state.profile.handle||'';
  $('#notice').value=state.profile.notice||'';
  $('#showNotice').checked=!!state.profile.showNotice;
  $('#topLogoUrl').value=state.profile.topLogoUrl||'';
  $('#brandCoopexUrl').value=state.profile.brandCoopexUrl||'';
  $('#brandKratosUrl').value=state.profile.brandKratosUrl||'';
  setPreview('#topLogoPrev', state.profile.topLogoUrl);
  setPreview('#brandCoopexPrev', state.profile.brandCoopexUrl);
  setPreview('#brandKratosPrev', state.profile.brandKratosUrl);
}
['name','handle','notice'].forEach(id=>$('#'+id).addEventListener('input',e=>state.profile[id]=e.target.value));
$('#showNotice').addEventListener('change',e=>state.profile.showNotice=e.target.checked);
['topLogoUrl','brandCoopexUrl','brandKratosUrl'].forEach(id=>{
  $('#'+id).addEventListener('input',e=>{ state.profile[id]=e.target.value; setPreview('#'+id.replace('Url','Prev'), e.target.value); });
});
$('#topLogoBtn').onclick = async ()=>{
  try{
    const f=$('#topLogoFile').files?.[0]; const url=await uploadTo('logos', f);
    state.profile.topLogoUrl=url; $('#topLogoUrl').value=url; setPreview('#topLogoPrev',url); msg('Logo do topo enviada!');
  }catch(e){ msg(e.message||'Falha no upload',false); }
};
$('#brandCoopexBtn').onclick = async ()=>{
  try{
    const f=$('#brandCoopexFile').files?.[0]; const url=await uploadTo('logos', f);
    state.profile.brandCoopexUrl=url; $('#brandCoopexUrl').value=url; setPreview('#brandCoopexPrev',url); msg('Logo COOPEX enviada!');
  }catch(e){ msg(e.message||'Falha no upload',false); }
};
$('#brandKratosBtn').onclick = async ()=>{
  try{
    const f=$('#brandKratosFile').files?.[0]; const url=await uploadTo('logos', f);
    state.profile.brandKratosUrl=url; $('#brandKratosUrl').value=url; setPreview('#brandKratosPrev',url); msg('Logo Kratos enviada!');
  }catch(e){ msg(e.message||'Falha no upload',false); }
};

/* ===== Links ===== */
function drawLinks(){
  const host=$('#links'); host.innerHTML='';
  state.links.forEach((l,idx)=>{
    const row=document.createElement('div'); row.className='link-row';
    row.innerHTML=`
      <input class="l-label" type="text" placeholder="Rótulo" value="${l.label||''}">
      <input class="l-url"   type="url"  placeholder="https://endereco-do-sistema" value="${l.url||''}">
      <input class="l-icon"  type="text" placeholder="icon (wa/yt/link)" value="${l.icon||'link'}">
      <div class="uploader">
        <img class="l-prev preview" src="${l.iconUrl||''}" ${l.iconUrl?'':'style="visibility:hidden"'} alt="">
        <input class="l-iurl"  type="url"  placeholder="iconUrl (preenchido após upload)" value="${l.iconUrl||''}">
        <input class="l-file"  type="file" accept="image/*">
        <button class="l-upload" type="button">Upload</button>
      </div>
      <button class="del" type="button">🗑</button>
    `;
    row.querySelector('.l-label').addEventListener('input',e=>state.links[idx].label=e.target.value);
    row.querySelector('.l-url').addEventListener('input',e=>state.links[idx].url=e.target.value);
    row.querySelector('.l-icon').addEventListener('input',e=>state.links[idx].icon=e.target.value);
    row.querySelector('.l-iurl').addEventListener('input',e=>{
      state.links[idx].iconUrl=e.target.value;
      const pv=row.querySelector('.l-prev'); if(e.target.value){ pv.src=e.target.value; pv.style.visibility='visible'; } else { pv.removeAttribute('src'); pv.style.visibility='hidden'; }
    });
    row.querySelector('.l-upload').addEventListener('click', async ()=>{
      try{
        const f=row.querySelector('.l-file').files?.[0]; const url=await uploadTo('link-icons', f);
        state.links[idx].iconUrl=url;
        row.querySelector('.l-iurl').value=url;
        const pv=row.querySelector('.l-prev'); pv.src=url; pv.style.visibility='visible';
        msg('Ícone do link enviado!');
      }catch(e){ msg(e.message||'Falha no upload',false); }
    });
    row.querySelector('.del').addEventListener('click',()=>{ state.links.splice(idx,1); drawLinks(); });
    host.append(row);
  });
}
$('#addLink').addEventListener('click',()=>{ state.links.push({label:'',url:'',icon:'link',iconUrl:''}); drawLinks(); });

/* ===== Vídeos ===== */
function drawVideos(){
  const host=$('#videos'); host.innerHTML='';
  (state.videos||[]).forEach((v,idx)=>{
    const row=document.createElement('div'); row.className='video-row';
    row.innerHTML=`
      <input class="v-title" type="text" placeholder="Título do vídeo" value="${v.title||''}">
      <div class="uploader">
        <img class="v-post preview" src="${v.poster||''}" ${v.poster?'':'style="visibility:hidden"'} alt="">
        <input class="v-poster" type="url" placeholder="Poster (preenchido após upload)" value="${v.poster||''}">
        <input class="v-poster-file" type="file" accept="image/*">
        <button class="v-poster-upload" type="button">Upload poster</button>
      </div>
      <div class="uploader">
        <input class="v-src" type="url" placeholder="URL do vídeo (preenchida após upload)" value="${v.src||''}">
        <input class="v-file" type="file" accept="video/*">
        <button class="v-upload" type="button">Upload vídeo</button>
      </div>
      <span class="small">type: <b>${v.type||'mp4url'}</b></span>
      <button class="del" type="button">🗑</button>
    `;
    row.querySelector('.v-title').addEventListener('input',e=>state.videos[idx].title=e.target.value);
    row.querySelector('.v-poster').addEventListener('input',e=>{
      state.videos[idx].poster=e.target.value;
      const pv=row.querySelector('.v-post'); if(e.target.value){ pv.src=e.target.value; pv.style.visibility='visible'; } else { pv.removeAttribute('src'); pv.style.visibility='hidden'; }
    });
    row.querySelector('.v-poster-upload').addEventListener('click', async ()=>{
      try{
        const f=row.querySelector('.v-poster-file').files?.[0]; const url=await uploadTo('video-posters', f);
        state.videos[idx].poster=url;
        row.querySelector('.v-poster').value=url;
        const pv=row.querySelector('.v-post'); pv.src=url; pv.style.visibility='visible';
        msg('Poster enviado!');
      }catch(e){ msg(e.message||'Falha no upload',false); }
    });
    row.querySelector('.v-src').addEventListener('input',e=>{ state.videos[idx].src=e.target.value; state.videos[idx].type='mp4url'; });
    row.querySelector('.v-upload').addEventListener('click', async ()=>{
      try{
        const f=row.querySelector('.v-file').files?.[0]; const url=await uploadTo('videos', f);
        state.videos[idx].src=url; state.videos[idx].type='mp4url';
        row.querySelector('.v-src').value=url;
        msg('Vídeo enviado!');
      }catch(e){ msg(e.message||'Falha no upload',false); }
    });
    row.querySelector('.del').addEventListener('click',()=>{ state.videos.splice(idx,1); drawVideos(); });
    host.append(row);
  });
}
$('#addVideo').addEventListener('click',()=>{ (state.videos=state.videos||[]).push({title:'',type:'mp4url',src:'',poster:''}); drawVideos(); });

/* ===== Load / Save ===== */
$('#btnLoad').addEventListener('click', async ()=>{
  try{
    const snap=await getDoc(doc(db,'sites',DOC_ID));
    state = snap.exists()? snap.data() : empty();
    fillProfile(); drawLinks(); drawVideos();
    msg('Dados carregados.');
  }catch(e){ msg('Erro ao carregar: '+(e.message||e.code), false); }
});
$('#btnSave').addEventListener('click', async ()=>{
  try{
    if(!auth.currentUser){ msg('Faça login antes de salvar.', false); return; }
    // saneamento
    state.links = (state.links||[]).filter(l=> (l.label||'').trim() && (l.url||'').trim());
    state.videos = (state.videos||[]).filter(v=> (v.src||'').trim());
    await setDoc(doc(db,'sites',DOC_ID), state, {merge:true});
    msg('Salvo no Firebase! ✅');
  }catch(e){ msg('Erro ao salvar: '+(e.message||e.code), false); }
});
$('#btnDownload').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='config.json'; a.click(); URL.revokeObjectURL(url);
});
$('#btnCopy').addEventListener('click',()=>{
  const pub = location.origin + location.pathname.replace(/\/admin\.html$/,'/');
  navigator.clipboard?.writeText(pub); msg('Link público copiado: '+pub);
});

/* ===== Inicial (se quiser um default) ===== */
state = {
  "profile": {
    "name": "Coopex Motofrete",
    "handle": "@coopex",
    "topLogoUrl": "",
    "brandCoopexUrl": "",
    "brandKratosUrl": "",
    "showNotice": true,
    "notice": "Plantão 24h. Segurança em primeiro lugar!"
  },
  "links": [
    { "label": "Supervisão", "url": "https://exemplo.coopex.com.br/super", "icon": "link", "iconUrl": "" },
    { "label": "Peninha",    "url": "https://exemplo.coopex.com.br/peninha", "icon": "link", "iconUrl": "" }
  ],
  "videos": [
    { "title": "Apresentação", "type": "mp4url", "src": "", "poster": "" }
  ]
};
fillProfile(); drawLinks(); drawVideos();
</script>
</body>
</html>

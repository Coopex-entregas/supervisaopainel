<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Ä¢ Gerenciador COOPEX</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#0b1020; --bg2:#121a33;
  --brand:#3b82f6; --brand2:#14b8a6; --brand3:#a855f7; --ok:#10b981; --err:#ef4444;
  --line:#223055; --card:#0e1730; --ink:#e9efff; --muted:#a9b6d9;
}
*{box-sizing:border-box} html,body{margin:0}
body{
  font-family:Inter,system-ui,Arial; color:var(--ink);
  background: radial-gradient(900px 600px at 10% -10%, #1b2a5a55 0%, transparent 60%),
              radial-gradient(900px 600px at 110% -20%, #7c3aed33 0%, transparent 60%),
              linear-gradient(180deg,var(--bg1),var(--bg2));
  min-height:100vh;
}

/* ===== Topbar ===== */
.topbar{
  position:sticky; top:0; z-index:50;
  backdrop-filter: blur(10px);
  background:linear-gradient(180deg,#0c1226cc,#0c122680);
  border-bottom:1px solid var(--line);
}
.topbar-inner{
  max-width:1100px; margin:0 auto; padding:12px 16px;
  display:flex; align-items:center; gap:14px;
}
.badge{
  width:38px;height:38px;border-radius:50%;
  background:conic-gradient(from 130deg,var(--brand),var(--brand3),var(--brand2),var(--brand));
  box-shadow:0 0 0 3px #0b1020, 0 10px 30px #3b82f655;
}
.title{font-weight:800;letter-spacing:.4px}
.sub{color:var(--muted);font-size:.9rem}
.top-actions{margin-left:auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:12px;border:1px solid var(--line);
  background:linear-gradient(180deg,#0f1a38,#0d1631); color:var(--ink);
  font-weight:800; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 10px 24px #0006 }
.btn-ghost{background:transparent}
.small{font-size:.9rem;color:var(--muted)}
.ok{color:var(--ok);font-weight:800}
.err{color:var(--err);font-weight:800}

/* ===== Layout ===== */
.wrap{max-width:1100px;margin:18px auto 80px;padding:0 16px}
.card{
  background:linear-gradient(180deg,#0e1730,#0c142a);
  border:1px solid var(--line); border-radius:18px; padding:16px; margin:16px 0;
  box-shadow:0 18px 40px #0007, inset 0 0 70px #ffffff05;
}
.card h3{margin:0 0 10px;font-weight:800}
.hr{height:1px;background:linear-gradient(90deg,transparent,#2a3a70,transparent);margin:12px 0}

/* ===== Forms ===== */
.grid-row{display:grid;grid-template-columns:220px 1fr;gap:14px;align-items:center;margin:10px 0}
@media (max-width:900px){ .grid-row{grid-template-columns:1fr} }
label{font-weight:800;color:#cdd7ff}
input[type=text],input[type=url],input[type=email],input[type=password],textarea{
  width:100%;padding:11px 12px;border-radius:12px;border:1px solid #25335c;background:#0c1530;color:#e9efff
}
textarea{min-height:90px;resize:vertical}

/* ===== Upload widgets ===== */
.uploader{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.file{position:relative}
.file input[type=file]{padding:10px;background:#0c1530;border:1px dashed #304074;border-radius:10px;color:#a9b6d9}
.pill{padding:8px 10px;border-radius:999px;background:#0f1a38;border:1px solid #25335c}
.preview{width:44px;height:44px;border-radius:10px;border:1px solid #2a3a70;object-fit:cover;background:#0c1530}
.progress{height:8px;border-radius:999px;background:#0c1530;border:1px solid #25335c;overflow:hidden;min-width:160px}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));width:0%}

/* ===== Lists ===== */
.head-row,.link-row,.video-row{display:grid;gap:10px;align-items:center;margin:10px 0}
.head-row{grid-template-columns:1.1fr 1.6fr .9fr 2fr 1fr .6fr}
.link-row{grid-template-columns:1.1fr 1.6fr .9fr 2fr 1fr .6fr}
.video-row{grid-template-columns:1.2fr 2fr 1.6fr 1fr .6fr}
@media (max-width:1000px){
  .head-row,.link-row,.video-row{grid-template-columns:1fr}
}
.icon-del{
  background:#1b274d;border:1px solid #25335c;border-radius:10px;padding:9px 10px;cursor:pointer
}
.addbar{display:flex;gap:10px;flex-wrap:wrap}

/* alert bar */
.alert{
  margin-top:6px; padding:8px 12px; border-radius:10px; border:1px solid #223055; background:#0f1a38;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="badge"></div>
    <div>
      <div class="title">Admin ‚Ä¢ COOPEX</div>
      <div class="sub">Fa√ßa upload das logos, √≠cones e v√≠deos. Depois clique em <b>Salvar no Firebase</b>.</div>
    </div>
    <div class="top-actions">
      <div id="authZone">
        <input id="email" type="email" placeholder="admin@coopex.com.br" class="pill">
        <input id="pass" type="password" placeholder="Senha" class="pill">
        <button id="btnLogin" class="btn">Entrar</button>
      </div>
      <div id="loggedZone" style="display:none">
        <span id="who" class="small"></span>
        <button id="btnLogout" class="btn btn-ghost">Sair</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- A√ß√µes globais -->
  <section class="card">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button id="btnLoad" class="btn">‚§ì Carregar do Firebase</button>
      <button id="btnSave" class="btn">‚§í Salvar no Firebase</button>
      <button id="btnDownload" class="btn btn-ghost">‚á© Baixar config.json</button>
      <button id="btnCopy" class="btn btn-ghost">üîó Copiar link p√∫blico</button>
      <span id="msg" class="small"></span>
    </div>
    <div class="alert small">
      <b>Como enviar:</b> 1) <em>Selecionar arquivo</em> ‚Üí 2) <em>Enviar</em>. O campo ao lado ficar√° com uma URL do Firebase.
    </div>
  </section>

  <!-- Perfil -->
  <section class="card">
    <h3>Perfil</h3>

    <div class="grid-row"><label>Nome</label><input id="name" type="text"></div>
    <div class="grid-row"><label>@handle / subt√≠tulo</label><input id="handle" type="text"></div>
    <div class="grid-row"><label>Quadro de Aviso</label><textarea id="notice"></textarea></div>
    <div class="grid-row"><label>Mostrar aviso?</label><input id="showNotice" type="checkbox" checked></div>

    <div class="hr"></div>

    <div class="grid-row"><label>Logo topo (redonda)</label>
      <div class="uploader">
        <img id="topLogoPrev" class="preview" alt="">
        <input id="topLogoUrl" class="pill" type="url" placeholder="URL do upload (preenchida ap√≥s enviar)">
        <span class="file"><input id="topLogoFile" type="file" accept="image/*"></span>
        <button id="topLogoBtn" class="btn">Enviar</button>
        <div class="progress"><span id="topLogoProg"></span></div>
      </div>
    </div>

    <div class="grid-row"><label>Logo COOPEX (rodap√©)</label>
      <div class="uploader">
        <img id="brandCoopexPrev" class="preview" alt="">
        <input id="brandCoopexUrl" class="pill" type="url" placeholder="URL do upload (preenchida ap√≥s enviar)">
        <span class="file"><input id="brandCoopexFile" type="file" accept="image/*"></span>
        <button id="brandCoopexBtn" class="btn">Enviar</button>
        <div class="progress"><span id="brandCoopexProg"></span></div>
      </div>
    </div>

    <div class="grid-row"><label>Logo Kratos (rodap√©)</label>
      <div class="uploader">
        <img id="brandKratosPrev" class="preview" alt="">
        <input id="brandKratosUrl" class="pill" type="url" placeholder="URL do upload (preenchida ap√≥s enviar)">
        <span class="file"><input id="brandKratosFile" type="file" accept="image/*"></span>
        <button id="brandKratosBtn" class="btn">Enviar</button>
        <div class="progress"><span id="brandKratosProg"></span></div>
      </div>
    </div>
  </section>

  <!-- Links -->
  <section class="card">
    <h3>Links</h3>
    <div class="head-row small" style="opacity:.8">
      <div><b>R√≥tulo</b></div><div><b>URL</b></div><div><b>√çcone</b> (wa/yt/link)</div><div><b>√çcone por upload</b> (gera iconUrl)</div><div><b>Progresso</b></div><div></div>
    </div>
    <div id="links"></div>
    <div class="addbar"><button id="addLink" class="btn">+ Adicionar link</button></div>
  </section>

  <!-- V√≠deos -->
  <section class="card">
    <h3>V√≠deos</h3>
    <div class="head-row small" style="opacity:.8">
      <div><b>T√≠tulo</b></div><div><b>Arquivo de v√≠deo</b> (gera src)</div><div><b>Poster (imagem)</b></div><div><b>Tipo</b></div><div></div>
    </div>
    <div id="videos"></div>
    <div class="addbar"><button id="addVideo" class="btn">+ Adicionar v√≠deo</button></div>
  </section>

</main>

<script type="module">
/* ========== Firebase SDKs ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

/* ========== CONFIG (bucket appspot.com) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyA0nxRSImbagy4EbWgLD9_2Hr_PYtWVPnM",
  authDomain: "kratossystemlinks.firebaseapp.com",
  projectId: "kratossystemlinks",
  storageBucket: "kratossystemlinks.appspot.com", // <- correto
  messagingSenderId: "721987032189",
  appId: "1:721987032189:web:9a82953e128b9398c04d14"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app); // usa o bucket do config
const DOC_ID = "supervisaopainel";

/* ========== Utils UI ========== */
const $=s=>document.querySelector(s);
const msg=(t,ok=true)=>{ const el=$('#msg'); el.textContent=t; el.className='small ' + (ok?'ok':'err'); };
function setPrev(sel,url){ const el=$(sel); if(url){ el.src=url; el.style.visibility='visible'; } else { el.removeAttribute('src'); el.style.visibility='hidden'; } }
function setBar(el, p){ el.style.width = Math.max(2, Math.min(100, p))+'%'; }

/* ========== Auth ========== */
onAuthStateChanged(auth,u=>{
  if(u){ $('#authZone').style.display='none'; $('#loggedZone').style.display='flex'; $('#who').textContent=u.email; }
  else { $('#authZone').style.display='flex'; $('#loggedZone').style.display='none'; }
});
$('#btnLogin').onclick = async ()=>{
  try{ await signInWithEmailAndPassword(auth,$('#email').value.trim(),$('#pass').value); msg('Login OK'); }
  catch(e){ msg('Falha no login: '+(e.message||e.code),false); }
};
$('#btnLogout').onclick = async ()=>{ await signOut(auth); msg('Saiu.'); };

/* ========== Estado ========== */
function empty(){
  return { profile:{name:'',handle:'',topLogoUrl:'',brandCoopexUrl:'',brandKratosUrl:'',showNotice:true,notice:''},
           links:[], videos:[] };
}
let state = empty();

/* ========== Upload gen√©rico (com progresso) ========== */
async function uploadWithProgress(prefix, file, barEl){
  if(!file) throw new Error('Selecione um arquivo.');
  const path = `${prefix}/${Date.now()}-${file.name}`;
  const task = uploadBytesResumable(sref(storage, path), file);
  return await new Promise((resolve,reject)=>{
    task.on('state_changed',
      snap => setBar(barEl, (snap.bytesTransferred/snap.totalBytes)*100 ),
      err  => reject(err),
      async()=> resolve(await getDownloadURL(task.snapshot.ref))
    );
  });
}

/* ========== Perfil bindings ========== */
function fillProfile(){
  $('#name').value=state.profile.name||'';
  $('#handle').value=state.profile.handle||'';
  $('#notice').value=state.profile.notice||'';
  $('#showNotice').checked=!!state.profile.showNotice;
  $('#topLogoUrl').value=state.profile.topLogoUrl||''; setPrev('#topLogoPrev', state.profile.topLogoUrl);
  $('#brandCoopexUrl').value=state.profile.brandCoopexUrl||''; setPrev('#brandCoopexPrev', state.profile.brandCoopexUrl);
  $('#brandKratosUrl').value=state.profile.brandKratosUrl||''; setPrev('#brandKratosPrev', state.profile.brandKratosUrl);
}
['name','handle','notice'].forEach(id=>$('#'+id).addEventListener('input',e=>state.profile[id]=e.target.value));
$('#showNotice').onchange = e => state.profile.showNotice = e.target.checked;
['topLogoUrl','brandCoopexUrl','brandKratosUrl'].forEach(id=>{
  $('#'+id).addEventListener('input',e=>{ state.profile[id]=e.target.value; setPrev('#'+id.replace('Url','Prev'), e.target.value); });
});
$('#topLogoBtn').onclick = async ()=>{
  try{
    const url = await uploadWithProgress('logos', $('#topLogoFile').files?.[0], $('#topLogoProg'));
    state.profile.topLogoUrl=url; $('#topLogoUrl').value=url; setPrev('#topLogoPrev',url); msg('Logo topo enviada!');
  }catch(e){ msg('Upload falhou: '+(e.message||e.code),false); }
};
$('#brandCoopexBtn').onclick = async ()=>{
  try{
    const url = await uploadWithProgress('logos', $('#brandCoopexFile').files?.[0], $('#brandCoopexProg'));
    state.profile.brandCoopexUrl=url; $('#brandCoopexUrl').value=url; setPrev('#brandCoopexPrev',url); msg('Logo COOPEX enviada!');
  }catch(e){ msg('Upload falhou: '+(e.message||e.code),false); }
};
$('#brandKratosBtn').onclick = async ()=>{
  try{
    const url = await uploadWithProgress('logos', $('#brandKratosFile').files?.[0], $('#brandKratosProg'));
    state.profile.brandKratosUrl=url; $('#brandKratosUrl').value=url; setPrev('#brandKratosPrev',url); msg('Logo Kratos enviada!');
  }catch(e){ msg('Upload falhou: '+(e.message||e.code),false); }
};

/* ========== Links ========== */
function drawLinks(){
  const host=$('#links'); host.innerHTML='';
  state.links.forEach((l,idx)=>{
    const row=document.createElement('div'); row.className='link-row';
    row.innerHTML=`
      <input class="l-label" type="text" placeholder="R√≥tulo" value="${l.label||''}">
      <input class="l-url"   type="url"  placeholder="https://seu-sistema..." value="${l.url||''}">
      <input class="l-icon"  type="text" placeholder="wa | yt | link" value="${l.icon||'link'}">
      <div class="uploader">
        <img class="l-prev preview" src="${l.iconUrl||''}" ${l.iconUrl?'':'style="visibility:hidden"'} alt="">
        <input class="l-iurl pill" type="url" placeholder="iconUrl (preenchida ap√≥s enviar)" value="${l.iconUrl||''}">
        <span class="file"><input class="l-file" type="file" accept="image/*"></span>
        <button class="l-send btn" type="button">Enviar</button>
      </div>
      <div class="progress"><span class="l-bar"></span></div>
      <button class="icon-del" title="Remover">üóë</button>
    `;
    row.querySelector('.l-label').oninput=e=>state.links[idx].label=e.target.value;
    row.querySelector('.l-url').oninput=e=>state.links[idx].url=e.target.value;
    row.querySelector('.l-icon').oninput=e=>state.links[idx].icon=e.target.value||'link';
    row.querySelector('.l-iurl').oninput=e=>{
      state.links[idx].iconUrl=e.target.value;
      const p=row.querySelector('.l-prev'); if(e.target.value){p.src=e.target.value;p.style.visibility='visible';}else{p.removeAttribute('src');p.style.visibility='hidden';}
    };
    row.querySelector('.l-send').onclick=async()=>{
      try{
        const f=row.querySelector('.l-file').files?.[0];
        const url=await uploadWithProgress('link-icons', f, row.querySelector('.l-bar'));
        state.links[idx].iconUrl=url; row.querySelector('.l-iurl').value=url;
        const p=row.querySelector('.l-prev'); p.src=url; p.style.visibility='visible';
        msg('√çcone do link enviado!');
      }catch(e){ msg('Upload falhou: '+(e.message||e.code),false); }
    };
    row.querySelector('.icon-del').onclick=()=>{ state.links.splice(idx,1); drawLinks(); };
    host.append(row);
  });
}
$('#addLink').onclick=()=>{ state.links.push({label:'',url:'',icon:'link',iconUrl:''}); drawLinks(); };

/* ========== V√≠deos ========== */
function drawVideos(){
  const host=$('#videos'); host.innerHTML='';
  (state.videos||[]).forEach((v,idx)=>{
    const row=document.createElement('div'); row.className='video-row';
    row.innerHTML=`
      <input class="v-title" type="text" placeholder="T√≠tulo" value="${v.title||''}">
      <div class="uploader">
        <input class="v-src pill" type="url" placeholder="src (preenchido ap√≥s enviar)" value="${v.src||''}">
        <span class="file"><input class="v-file" type="file" accept="video/*"></span>
        <button class="v-send btn" type="button">Enviar v√≠deo</button>
        <div class="progress" style="min-width:120px"><span class="v-bar"></span></div>
      </div>
      <div class="uploader">
        <img class="v-prev preview" src="${v.poster||''}" ${v.poster?'':'style="visibility:hidden"'} alt="">
        <input class="v-poster pill" type="url" placeholder="poster (preenchido ap√≥s enviar)" value="${v.poster||''}">
        <span class="file"><input class="v-post-file" type="file" accept="image/*"></span>
        <button class="v-post-send btn" type="button">Enviar poster</button>
      </div>
      <div class="pill small">type: <b>${v.type||'mp4url'}</b></div>
      <button class="icon-del" title="Remover">üóë</button>
    `;
    row.querySelector('.v-title').oninput=e=>state.videos[idx].title=e.target.value;
    row.querySelector('.v-src').oninput=e=>{ state.videos[idx].src=e.target.value; state.videos[idx].type='mp4url'; };
    row.querySelector('.v-poster').oninput=e=>{
      state.videos[idx].poster=e.target.value;
      const p=row.querySelector('.v-prev'); if(e.target.value){p.src=e.target.value;p.style.visibility='visible';}else{p.removeAttribute('src');p.style.visibility='hidden';}
    };
    row.querySelector('.v-send').onclick=async()=>{
      try{
        const f=row.querySelector('.v-file').files?.[0];
        const url=await uploadWithProgress('videos', f, row.querySelector('.v-bar'));
        state.videos[idx].src=url; state.videos[idx].type='mp4url'; row.querySelector('.v-src').value=url;
        msg('V√≠deo enviado!');
      }catch(e){ msg('Upload falhou: '+(e.message||e.code),false); }
    };
    row.querySelector('.v-post-send').onclick=async()=>{
      try{
        const f=row.querySelector('.v-post-file').files?.[0];
        const url=await uploadWithProgress('video-posters', f, document.createElement('span')); // sem barra dedicada
        state.videos[idx].poster=url; row.querySelector('.v-poster').value=url;
        const p=row.querySelector('.v-prev'); p.src=url; p.style.visibility='visible';
        msg('Poster enviado!');
      }catch(e){ msg('Upload falhou: '+(e.message||e.code),false); }
    };
    row.querySelector('.icon-del').onclick=()=>{ state.videos.splice(idx,1); drawVideos(); };
    host.append(row);
  });
}
$('#addVideo').onclick=()=>{ (state.videos=state.videos||[]).push({title:'',type:'mp4url',src:'',poster:''}); drawVideos(); };

/* ========== Load / Save / Outras a√ß√µes ========== */
$('#btnLoad').onclick = async ()=>{
  try{
    const snap=await getDoc(doc(db,'sites',DOC_ID));
    state = snap.exists()? snap.data() : empty();
    fillProfile(); drawLinks(); drawVideos();
    msg('Dados carregados.');
  }catch(e){ msg('Erro ao carregar: '+(e.message||e.code), false); }
};
$('#btnSave').onclick = async ()=>{
  try{
    if(!auth.currentUser){ msg('Fa√ßa login antes de salvar.',false); return; }
    state.links  = (state.links||[]).filter(l=> (l.label||'').trim() && (l.url||'').trim());
    state.videos = (state.videos||[]).filter(v=> (v.src||'').trim());
    await setDoc(doc(db,'sites',DOC_ID), state, {merge:true});
    msg('Salvo no Firebase! ‚úÖ');
  }catch(e){ msg('Erro ao salvar: '+(e.message||e.code), false); }
};
$('#btnDownload').onclick = ()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='config.json'; a.click(); URL.revokeObjectURL(url);
};
$('#btnCopy').onclick = ()=>{
  const pub = location.origin + location.pathname.replace(/\/admin\.html$/,'/');
  navigator.clipboard?.writeText(pub); msg('Link p√∫blico copiado!');
};

/* ========== Estado inicial (uma linha pronta pra editar) ========== */
state = {
  profile:{name:"Coopex Entregas",handle:"Feito sob medida para voce ‚ô•",topLogoUrl:"",brandCoopexUrl:"",brandKratosUrl:"",showNotice:true,notice:"Lembre-se de Salvar sempre o login no navegador!"},
  links:[{label:"Supervis√£o",url:"",icon:"link",iconUrl:""}],
  videos:[{title:"Apresenta√ß√£o",type:"mp4url",src:"",poster:""}]
};
fillProfile(); drawLinks(); drawVideos();
</script>

</body>
</html>
